# PowerSync Sync Rules for Multi-Tenant HMS/PMS
# Generated for two-tier user system: Platform Admins + Tenant Users

bucket_definitions:
  # ==========================================
  # BUCKET 1: Tenant Data (Hotel Staff)
  # ==========================================
  tenant_data:
    parameters:
      - SELECT request.user_id() AS user_id
      - SELECT 
          user_roles.tenant_id,
          tenants.name AS tenant_name
        FROM user_roles
        JOIN tenants ON tenants.id = user_roles.tenant_id
        WHERE user_roles.user_id = request.user_id()
        LIMIT 1

    data:
      # ==========================================
      # CORE OPERATIONS
      # ==========================================
      - SELECT * FROM bookings 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM guests 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM rooms 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM room_types 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM room_status_history 
        WHERE tenant_id = bucket.tenant_id

      # ==========================================
      # REQUESTS & COMMUNICATIONS
      # ==========================================
      - SELECT * FROM requests 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM guest_communications 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM guest_feedback 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM guest_orders 
        WHERE tenant_id = bucket.tenant_id

      # ==========================================
      # PAYMENTS & FINANCIALS
      # ==========================================
      - SELECT * FROM payments 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM receivables 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM stay_folios 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM folio_transactions 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM wallets 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM wallet_transactions 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM booking_charges 
        WHERE tenant_id = bucket.tenant_id

      # ==========================================
      # FINANCE CENTER
      # ==========================================
      - SELECT * FROM finance_providers 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM finance_locations 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM finance_provider_rules 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM finance_reconciliation_records 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM finance_reconciliation_audit 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM finance_analytics_snapshots 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM finance_audit_events 
        WHERE tenant_id = bucket.tenant_id

      # ==========================================
      # STAFF & PERMISSIONS
      # ==========================================
      - SELECT * FROM staff 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM user_roles 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM navigation_items 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM hotel_permissions 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM staff_shifts 
        WHERE tenant_id = bucket.tenant_id

      # ==========================================
      # HOTEL CONFIGURATION
      # ==========================================
      - SELECT * FROM hotel_branding 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM hotel_configurations 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM hotel_meta 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM hotel_financials 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM hotel_payment_preferences 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM hotel_config_snapshots 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM hotel_domains 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM document_templates 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM email_settings 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM hotel_dashboard_defaults 
        WHERE tenant_id = bucket.tenant_id

      # ==========================================
      # INVENTORY & PROCUREMENT
      # ==========================================
      - SELECT * FROM inventory_items 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM department_stock 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM department_requests 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM purchase_orders 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM stock_movements 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM suppliers 
        WHERE tenant_id = bucket.tenant_id

      # ==========================================
      # MENU & SERVICES
      # ==========================================
      - SELECT * FROM menu_items 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM laundry_items 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM spa_services 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM service_categories 
        WHERE tenant_id = bucket.tenant_id

      # ==========================================
      # QR SYSTEM
      # ==========================================
      - SELECT * FROM qr_codes 
        WHERE tenant_id = bucket.tenant_id

      # ==========================================
      # ORGANIZATIONS (B2B)
      # ==========================================
      - SELECT * FROM organizations 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM organization_members 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM organization_service_rules 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM organization_wallet_rules 
        WHERE tenant_id = bucket.tenant_id

      # ==========================================
      # PLATFORM FEES
      # ==========================================
      - SELECT * FROM platform_fee_ledger 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM platform_fee_configurations 
        WHERE tenant_id = bucket.tenant_id

      # ==========================================
      # AUDIT & LOGS
      # ==========================================
      - SELECT * FROM hotel_audit_logs 
        WHERE tenant_id = bucket.tenant_id

      - SELECT * FROM notification_sounds 
        WHERE tenant_id = bucket.tenant_id

      # ==========================================
      # USER PROFILE (Current User Only)
      # ==========================================
      - SELECT * FROM profiles 
        WHERE id = bucket.user_id

  # ==========================================
  # BUCKET 2: Global Admin (Platform Users)
  # ==========================================
  global_admin:
    parameters:
      - SELECT request.user_id() AS user_id
      - SELECT 
          CASE 
            WHEN EXISTS(SELECT 1 FROM platform_users WHERE id = request.user_id()) 
            THEN true 
            ELSE false 
          END AS is_platform_admin

    data:
      # ==========================================
      # PLATFORM MANAGEMENT TABLES
      # ==========================================
      - SELECT * FROM platform_users 
        WHERE id = bucket.user_id

      - SELECT * FROM platform_tenants

      - SELECT * FROM platform_plans

      - SELECT * FROM tenants

      - SELECT * FROM platform_sms_credits

      # ==========================================
      # ALL TENANT DATA (Full Access)
      # ==========================================
      - SELECT * FROM bookings

      - SELECT * FROM guests

      - SELECT * FROM rooms

      - SELECT * FROM room_types

      - SELECT * FROM room_status_history

      - SELECT * FROM requests

      - SELECT * FROM guest_communications

      - SELECT * FROM guest_feedback

      - SELECT * FROM guest_orders

      - SELECT * FROM payments

      - SELECT * FROM receivables

      - SELECT * FROM stay_folios

      - SELECT * FROM folio_transactions

      - SELECT * FROM wallets

      - SELECT * FROM wallet_transactions

      - SELECT * FROM booking_charges

      - SELECT * FROM finance_providers

      - SELECT * FROM finance_locations

      - SELECT * FROM finance_provider_rules

      - SELECT * FROM finance_reconciliation_records

      - SELECT * FROM finance_reconciliation_audit

      - SELECT * FROM finance_analytics_snapshots

      - SELECT * FROM finance_audit_events

      - SELECT * FROM staff

      - SELECT * FROM user_roles

      - SELECT * FROM navigation_items

      - SELECT * FROM hotel_permissions

      - SELECT * FROM staff_shifts

      - SELECT * FROM hotel_branding

      - SELECT * FROM hotel_configurations

      - SELECT * FROM hotel_meta

      - SELECT * FROM hotel_financials

      - SELECT * FROM hotel_payment_preferences

      - SELECT * FROM hotel_config_snapshots

      - SELECT * FROM hotel_domains

      - SELECT * FROM document_templates

      - SELECT * FROM email_settings

      - SELECT * FROM hotel_dashboard_defaults

      - SELECT * FROM inventory_items

      - SELECT * FROM department_stock

      - SELECT * FROM department_requests

      - SELECT * FROM purchase_orders

      - SELECT * FROM stock_movements

      - SELECT * FROM suppliers

      - SELECT * FROM menu_items

      - SELECT * FROM laundry_items

      - SELECT * FROM spa_services

      - SELECT * FROM service_categories

      - SELECT * FROM qr_codes

      - SELECT * FROM organizations

      - SELECT * FROM organization_members

      - SELECT * FROM organization_service_rules

      - SELECT * FROM organization_wallet_rules

      - SELECT * FROM platform_fee_ledger

      - SELECT * FROM platform_fee_configurations

      - SELECT * FROM hotel_audit_logs

      - SELECT * FROM notification_sounds

      # ==========================================
      # USER PROFILE
      # ==========================================
      - SELECT * FROM profiles
