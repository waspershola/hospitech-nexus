# =====================================================
# POWERSYNC SYNC RULES - VIEW-BASED ARCHITECTURE
# Multi-Tenant HMS/PMS with Two-Tier User System
# =====================================================
#
# Architecture:
# - Tenant Users: Access data through tenant-specific views (v_*)
# - Platform Admins: Full access to raw tables + platform management
#
# Security:
# - Views enforce tenant isolation at database level
# - No complex WHERE clauses in PowerSync rules
# - Centralized filtering logic in database
#
# =====================================================

bucket_definitions:
  # ===================================================
  # BUCKET 1: TENANT USERS (Hotel Staff)
  # ===================================================
  # Access: Only their tenant's data via views
  # Filter: Handled by database views using user_roles
  # ===================================================
  
  tenant_data:
    parameters:
      - SELECT request.user_id() AS user_id
    
    data:
      # =================================================
      # CORE OPERATIONS
      # =================================================
      
      - SELECT * FROM v_bookings
      - SELECT * FROM v_guests
      - SELECT * FROM v_rooms
      - SELECT * FROM v_room_types
      - SELECT * FROM v_room_status_history
      - SELECT * FROM v_room_categories
      
      # =================================================
      # REQUESTS & COMMUNICATIONS
      # =================================================
      
      - SELECT * FROM v_requests
      - SELECT * FROM v_guest_communications
      - SELECT * FROM v_guest_feedback
      - SELECT * FROM v_guest_orders
      
      # =================================================
      # PAYMENTS & FINANCIALS
      # =================================================
      
      - SELECT * FROM v_payments
      - SELECT * FROM v_receivables
      - SELECT * FROM v_stay_folios
      - SELECT * FROM v_folio_transactions
      - SELECT * FROM v_wallets
      - SELECT * FROM v_wallet_transactions
      - SELECT * FROM v_booking_charges
      - SELECT * FROM v_receipt_sequences
      
      # =================================================
      # FINANCE CENTER
      # =================================================
      
      - SELECT * FROM v_finance_providers
      - SELECT * FROM v_finance_locations
      - SELECT * FROM v_finance_provider_rules
      - SELECT * FROM v_finance_reconciliation_records
      - SELECT * FROM v_finance_reconciliation_audit
      - SELECT * FROM v_finance_analytics_snapshots
      - SELECT * FROM v_finance_audit_events
      
      # =================================================
      # STAFF & PERMISSIONS
      # =================================================
      
      - SELECT * FROM v_staff
      - SELECT * FROM v_user_roles
      - SELECT * FROM v_navigation_items
      - SELECT * FROM v_hotel_permissions
      
      # =================================================
      # HOTEL CONFIGURATION
      # =================================================
      
      - SELECT * FROM v_hotel_branding
      - SELECT * FROM v_hotel_configurations
      - SELECT * FROM v_hotel_meta
      - SELECT * FROM v_hotel_financials
      - SELECT * FROM v_hotel_payment_preferences
      - SELECT * FROM v_hotel_config_snapshots
      - SELECT * FROM v_hotel_domains
      - SELECT * FROM v_document_templates
      - SELECT * FROM v_email_settings
      - SELECT * FROM v_hotel_dashboard_defaults
      
      # =================================================
      # INVENTORY & PROCUREMENT
      # =================================================
      
      - SELECT * FROM v_inventory_items
      - SELECT * FROM v_department_stock
      - SELECT * FROM v_department_requests
      - SELECT * FROM v_purchase_orders
      - SELECT * FROM v_stock_movements
      - SELECT * FROM v_suppliers
      
      # =================================================
      # MENU & SERVICES
      # =================================================
      
      - SELECT * FROM v_menu_items
      - SELECT * FROM v_laundry_items
      - SELECT * FROM v_spa_services
      
      # =================================================
      # QR SYSTEM
      # =================================================
      
      - SELECT * FROM v_qr_codes
      - SELECT * FROM v_notification_sounds
      
      # =================================================
      # ORGANIZATIONS (B2B)
      # =================================================
      
      - SELECT * FROM v_organizations
      - SELECT * FROM v_organization_members
      - SELECT * FROM v_organization_service_rules
      - SELECT * FROM v_organization_wallet_rules
      
      # =================================================
      # PLATFORM FEES
      # =================================================
      
      - SELECT * FROM v_platform_fee_ledger
      - SELECT * FROM v_platform_fee_configurations
      
      # =================================================
      # AUDIT & LOGS
      # =================================================
      
      - SELECT * FROM v_hotel_audit_logs
      
      # =================================================
      # USER PROFILE (Current User Only)
      # =================================================
      
      - SELECT * FROM profiles WHERE id = bucket.user_id

  # ===================================================
  # BUCKET 2: PLATFORM ADMINS
  # ===================================================
  # Access: All tenant data + platform management tables
  # Filter: None (full access to raw tables)
  # ===================================================
  
  global_admin:
    parameters:
      - SELECT request.user_id() AS user_id
      - SELECT EXISTS(SELECT 1 FROM platform_users WHERE id = request.user_id()) AS is_platform_admin
    
    data:
      # =================================================
      # PLATFORM MANAGEMENT TABLES
      # =================================================
      
      - SELECT * FROM platform_users WHERE id = bucket.user_id
      - SELECT * FROM platform_tenants
      - SELECT * FROM tenants
      
      # =================================================
      # FULL ACCESS TO ALL TENANT DATA (RAW TABLES)
      # =================================================
      
      # Core Operations
      - SELECT * FROM bookings
      - SELECT * FROM guests
      - SELECT * FROM rooms
      - SELECT * FROM room_types
      - SELECT * FROM room_status_history
      - SELECT * FROM room_categories
      
      # Requests & Communications
      - SELECT * FROM requests
      - SELECT * FROM guest_communications
      - SELECT * FROM guest_feedback
      - SELECT * FROM guest_orders
      
      # Payments & Financials
      - SELECT * FROM payments
      - SELECT * FROM receivables
      - SELECT * FROM stay_folios
      - SELECT * FROM folio_transactions
      - SELECT * FROM wallets
      - SELECT * FROM wallet_transactions
      - SELECT * FROM booking_charges
      - SELECT * FROM receipt_sequences
      
      # Finance Center
      - SELECT * FROM finance_providers
      - SELECT * FROM finance_locations
      - SELECT * FROM finance_provider_rules
      - SELECT * FROM finance_reconciliation_records
      - SELECT * FROM finance_reconciliation_audit
      - SELECT * FROM finance_analytics_snapshots
      - SELECT * FROM finance_audit_events
      
      # Staff & Permissions
      - SELECT * FROM staff
      - SELECT * FROM user_roles
      - SELECT * FROM navigation_items
      - SELECT * FROM hotel_permissions
      
      # Hotel Configuration
      - SELECT * FROM hotel_branding
      - SELECT * FROM hotel_configurations
      - SELECT * FROM hotel_meta
      - SELECT * FROM hotel_financials
      - SELECT * FROM hotel_payment_preferences
      - SELECT * FROM hotel_config_snapshots
      - SELECT * FROM hotel_domains
      - SELECT * FROM document_templates
      - SELECT * FROM email_settings
      - SELECT * FROM hotel_dashboard_defaults
      
      # Inventory & Procurement
      - SELECT * FROM inventory_items
      - SELECT * FROM department_stock
      - SELECT * FROM department_requests
      - SELECT * FROM purchase_orders
      - SELECT * FROM stock_movements
      - SELECT * FROM suppliers
      
      # Menu & Services
      - SELECT * FROM menu_items
      - SELECT * FROM laundry_items
      - SELECT * FROM spa_services
      
      # QR System
      - SELECT * FROM qr_codes
      - SELECT * FROM notification_sounds
      
      # Organizations (B2B)
      - SELECT * FROM organizations
      - SELECT * FROM organization_members
      - SELECT * FROM organization_service_rules
      - SELECT * FROM organization_wallet_rules
      
      # Platform Fees
      - SELECT * FROM platform_fee_ledger
      - SELECT * FROM platform_fee_configurations
      
      # Audit & Logs
      - SELECT * FROM hotel_audit_logs
      
      # User Profiles
      - SELECT * FROM profiles
